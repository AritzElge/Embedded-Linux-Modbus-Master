#!/bin/sh

# S61error_blink_daemon: Launches system error code blink daemon with failover logic.

# Binary paths
HDD_BLINK_BINARY="/mnt/hdd/daemons/error_code_blink/error_code_blink"
SD_BLINK_BINARY="/usr/sbin/error_code_blink"
LOG_FILE="/dev/kmsg" # Kernel log for boot messages

# --- Function to write log messages ---
log_message() {
    echo "S61error_blink_daemon: $1" >> "$LOG_FILE"
}

# --- 1. Attempt to start the Blink Daemon from the HDD (Primary location) ---
if [ -f "$HDD_BLINK_BINARY" ]; then
    log_message "INFO: HDD mounted. Starting error_code_blink from HDD."
    # Execute in the background
    "$HDD_BLINK_BINARY" &
    PID=$!
    log_message "INFO: error_code_blink (HDD) started with PID $PID."

# --- 2. If the binary is not on the HDD, check the internal SD (Failover location) ---
elif [ -f "$SD_BLINK_BINARY" ]; then
    log_message "WARNING: Blink binary not found on HDD. Starting from SD backup (/usr/sbin/)."
    # Execute in the background
    "$SD_BLINK_BINARY" &
    PID=$!
    log_message "INFO: error_code_blink (SD) started with PID $PID."

# --- 3. If the binary is not found anywhere, report a critical error ---
else
    log_message "CRITICAL ERROR: error_code_blink binary not found on HDD or SD."
    # Write an error 15 (Blink daemon internal failure)
    echo -n "15" > /tmp/status/system_status.txt
fi

log_message "INFO: S61error_blink_daemons finished execution."

exit 0
