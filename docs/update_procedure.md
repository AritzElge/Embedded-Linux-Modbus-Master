# Offline Software Update Procedure

## Process Overview
The `ELI_galileo` system supports field software updates using a removable USB drive. This method is designed for environments without network connectivity, ensuring package integrity through version verification before installation.
The process involves the following steps:
1.   Preparation of the `.ipk` package on the Host PC.
2.  Transfer of the package to the USB Pendrive.
3.  Insertion of the Pendrive into the Galileo Gen 2 board.
4.  Automatic execution of the update script

## Pre-requisites
*   Formatted USB drive (FAT32 or ext4).
*   The new version `.ipk` package generated by the Buildroot compilation process (`ELI-galileo-vX.Y.Z.ipk`).
*   Physical access to the Intel Galileo Gen 2 board.

## Generating the Update Package
This step is performed on the Host PC after local compilation with `./setup.sh`:
1.  Navigate to the output directory where Buildroot stores the generated packages:
    '''
    cd output/images/ipk_packages/
    '''
2.  Locate the specific version .ipk file you wish to deploy (example: `ELI-galileo-v1.0.0.ipk`).

## Preparing the USB Pendrive
1.  Copy the generated `.ipk` package to the root directory of the USB drive:
    '''
    cp ELI-galileo-vX.Y.Z.ipk /media/user/MY_USB/
    '''
2.  **Important:** The update script automatically searches for `.ipk` files in the root directory of the USB drive. Do not place them in subfolders.
3.  Safely eject the pendrive from the Host PC.

## Executing the In-Field Update Procedure
This step is performed at the physical location of the Intel Galileo Gen 2 board:
1.  Insert the USB pendrive into the available Host USB port on the Galileo Gen 2 board **while the system is powered on and operational.**
2.  The system will automatically detect the USB insertion and execute the update script.

### Automatic Verification Mechanism
The update script performs the following security checks sequentially:
1.  **File Detection:** Confirms the presence of a valid `.ipk` file in the USB root directory.
2.  **Version Verification:** Compares the version of the USB `.ipk` package with the version currently installed on the system HDD. It will only proceed if the USB version is newer.
3.  **Dependency Management:** The package manager (`opkg`) verifies and resolves necessary dependencies before installation.

## Monitoring and Post-Update Verification
1.  **Physical Monitoring:** The status LED will blink rapidly during the installation process. It will return to the normal 1Hz heartbeat when the update is successful or if an error occurs.
2.  **Remote Monitoring (SSH):** If the network is available, you can monitor the progress and outcome of the update in the logs:
    '''
    tail -f /mnt/hdd/logs/system.log
    '''
3.  **System Reboot:** A full reboot of the board is required for all changes to take effect and for the new daemons to start correctly.
4.  **Final Confirmation:** After the reboot, verify the new software version via SSH or the LCD screen (if the interface allows).

## Error Handling and Rollback
The update mechanism incorporates basic error handling, but operator intervention may be required in certain failure scenarios.
1.  **Failure Prevention Strategy (UPS Integration)**
For production environments, the system is designed to be connected to an Uninterruptible Power Supply (UPS). This prevents data corruption or system failure during the critical package installation phase in the event of a power outage.

2.  **Failure Scenarios**
    *   **Version Mismatch:** If the USB package version is older than the installed version, the script will abort, and a log entry will be generated. The system will continue to run the current stable version.
    *   **Power Loss During Update:** A power loss during the package installation (opkg install) carries a risk of system corruption (bricking). The operator must follow the disaster recovery procedure using the dd command to re-flash the SD card with the last known stable image (see Deployment Guide, Section 3).
3.  **Manual Rollback Procedure (Contingency Plan)**
If a deployed software version causes system instability:
    1.  **Prepare** the USB drive with the last known stable `.ipk` package (e.g., v1.0.0 instead of the faulty v1.0.1).
    2.  **Modify** the version verification script temporarily (if necessary) to allow a "downgrade" installation in crisis situations.
    3.  **Insert** the USB and run the update procedure as usual.
    4.  **Monitor** the system closely during the reboot phase.
